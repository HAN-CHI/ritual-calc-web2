<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¦¾æ¬£ç”Ÿå‘½ç¦®å„€åŠ©æ‰‹</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/lunar-javascript/lunar.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;600;700;900&display=swap');
        
        :root {
            --brand-blue: #1e3a8a; /* ç¦¾æ¬£æ·±è— */
            --brand-gold: #b4925a; /* è³ªæ„Ÿé‡‘ */
            --bg-color: #fcfbf9;
        }

        body {
            font-family: 'Noto Serif TC', serif;
            background-color: var(--bg-color);
            color: #333;
            padding-bottom: 80px; /* é ç•™åº•éƒ¨ç©ºé–“ */
        }

        /* å“ç‰Œ Header */
        .brand-header {
            background: white;
            padding: 1rem;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
            margin-bottom: 1.5rem;
            border-bottom: 1px solid #eee;
        }
        .brand-logo {
            height: 80px; /* èª¿æ•´ LOGO å¤§å° */
            margin: 0 auto;
            object-fit: contain;
        }

        /* å°è¦½åˆ— (Tabs) */
        .nav-container {
            display: flex;
            overflow-x: auto;
            gap: 10px;
            padding: 0 1rem 1rem;
            scrollbar-width: none; /* Firefox */
            justify-content: flex-start;
        }
        .nav-container::-webkit-scrollbar { display: none; } /* Chrome */
        
        .nav-btn {
            white-space: nowrap;
            padding: 8px 16px;
            border-radius: 50px;
            font-size: 0.9rem;
            font-weight: 700;
            color: #666;
            background: white;
            border: 1px solid #e5e7eb;
            transition: all 0.3s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .nav-btn.active {
            background: var(--brand-blue);
            color: white;
            border-color: var(--brand-blue);
            box-shadow: 0 4px 10px rgba(30, 58, 138, 0.3);
        }

        /* å…§å®¹å¡ç‰‡å„ªåŒ– */
        .tab-content { display: none; animation: fadeIn 0.3s ease; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .card {
            background: #ffffff;
            border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.03);
            border: 1px solid rgba(180, 146, 90, 0.15); /* é‡‘è‰²å¾®é‚Šæ¡† */
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1.25rem;
            border-bottom: 2px solid var(--brand-gold);
            padding-bottom: 0.5rem;
        }
        .section-title {
            font-size: 1.2rem;
            font-weight: 900;
            color: var(--brand-blue);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* è¼¸å…¥èˆ‡æ§åˆ¶é …å„ªåŒ– */
        select, input, textarea {
            border: 1px solid #e2e8f0;
            padding: 0.7rem;
            border-radius: 12px;
            width: 100%;
            font-size: 0.95rem;
            background-color: #f8fafc;
            font-family: 'Noto Serif TC', serif;
            transition: border-color 0.2s;
        }
        select:focus, input:focus, textarea:focus {
            outline: none;
            border-color: var(--brand-blue);
            background-color: white;
        }
        .label-text {
            font-weight: 700;
            font-size: 0.85rem;
            color: #64748b;
            margin-bottom: 0.4rem;
            display: block;
        }

        /* æ¨¡å¼åˆ‡æ›æŒ‰éˆ• */
        .mode-toggle {
            background: #f1f5f9;
            padding: 4px;
            border-radius: 50px;
            display: flex;
        }
        .mode-btn {
            padding: 6px 14px;
            font-size: 0.75rem;
            border-radius: 50px;
            color: #64748b;
            font-weight: bold;
            transition: all 0.3s;
        }
        .mode-btn.active {
            background: var(--brand-blue);
            color: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        /* ç‰Œä½æ¨£å¼ */
        .ancestor-plate {
            background: #fffcf5;
            border: 4px double var(--brand-gold);
            position: relative;
            padding: 3rem 1.5rem;
            margin-top: 1.5rem;
            min-height: 180px;
            display: flex;
            align-items: center;
            justify-content: center;
            writing-mode: vertical-rl; /* ç›´æ›¸æ›´æœ‰è³ªæ„Ÿ */
            font-family: "KaiTi", "BiauKai", serif; /* æ¨™æ¥·é«” */
        }
        .ancestor-plate::before {
            content: "å»ºè­°ç‰Œä½æ ¼å¼";
            position: absolute;
            top: -12px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--brand-gold);
            color: white;
            padding: 4px 16px;
            font-size: 0.75rem;
            border-radius: 50px;
            writing-mode: horizontal-tb;
        }

        /* å‰å‡¶è‰²å¡Šå„ªåŒ– */
        .dir-item { 
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px 14px; border-radius: 12px; margin-bottom: 8px; 
            border: 1px solid transparent; font-weight: 600; font-size: 0.9rem;
        }
        .dir-best { background: #fffbeb; border-color: #fcd34d; color: #92400e; } 
        .dir-lucky { background: #f0fdf4; border-color: #86efac; color: #166534; } 
        .dir-small-lucky { background: #f0f9ff; border-color: #7dd3fc; color: #075985; } 
        .dir-bad { background: #fef2f2; border-color: #fca5a5; color: #991b1b; } 
        .dir-normal { background: #f8fafc; border-color: #e2e8f0; color: #64748b; }

        /* å…¶ä»–å…ƒä»¶ */
        .divider {
            position: relative;
            text-align: center;
            margin: 2rem 0 1.5rem;
        }
        .divider::before {
            content: "";
            position: absolute;
            top: 50%; left: 0; width: 100%; height: 1px;
            background: #e2e8f0;
        }
        .divider span {
            position: relative;
            background: white;
            padding: 0 15px;
            color: #94a3b8;
            font-size: 0.75rem;
            font-weight: bold;
        }

        .xm-result-box {
            background: white;
            border: 1px solid #e2e8f0;
            border-left: 4px solid var(--brand-blue);
            border-radius: 8px;
            padding: 12px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.02);
        }
        .xm-tag {
            display: inline-block; padding: 3px 8px; border-radius: 4px;
            font-size: 11px; font-weight: bold; margin-bottom: 6px;
        }
        .xm-tag-red { background: #fee2e2; color: #b91c1c; }
        .xm-tag-blue { background: #e0f2fe; color: #0369a1; }
        .xm-tag-amber { background: #fffbeb; color: #b45309; }
    </style>
</head>
<body class="bg-stone-50">

    <header class="brand-header">
        <img src="YTå½±ç‰‡ LOGO-02.png" alt="ç¦¾æ¬£ç”Ÿå‘½ç¦®å„€" class="brand-logo">
        <h1 class="text-xl font-black tracking-[0.2em] text-slate-800 mt-2">ç”Ÿå‘½ç¦®å„€å°ˆæ¥­åŠ©æ‰‹</h1>
        <p class="text-[10px] text-amber-600 mt-1 font-bold tracking-widest uppercase">Professional Funeral Service System</p>
    </header>

    <div class="max-w-4xl mx-auto px-4">
        
        <nav class="nav-container">
            <button onclick="switchTab('cal')" id="tab-cal" class="nav-btn active">ğŸ“… æ›†æ³•å¹´è™Ÿ</button>
            <button onclick="switchTab('cer')" id="tab-cer" class="nav-btn">âš–ï¸ ç¥­ç¥€å°å¹´</button>
            <button onclick="switchTab('fs')" id="tab-fs" class="nav-btn">ğŸ§­ å¡”ä½é‘‘å®š</button>
            <button onclick="switchTab('data')" id="tab-data" class="nav-btn">ğŸº ä»™å‘½å‘½ç†</button>
            <button onclick="switchTab('ai')" id="tab-ai" class="nav-btn">ğŸ’¡ AI é¡§å•</button>
        </nav>

        <div id="panel-cal" class="tab-content active space-y-4">
            <div class="card">
                <div class="section-header">
                    <div class="section-title"><span>ğŸ“…</span> åœ‹è¾²æ›†é›™å‘æŸ¥è©¢</div>
                    <div class="mode-toggle">
                        <button id="btnSolarMode" class="mode-btn active" onclick="setCalendarMode('solar')">åœ‹è½‰è¾²</button>
                        <button id="btnLunarMode" class="mode-btn" onclick="setCalendarMode('lunar')">è¾²è½‰åœ‹</button>
                    </div>
                </div>
                
                <div class="space-y-4">
                    <div id="solarInputArea" class="space-y-3">
                        <div><label class="label-text">åœ‹æ›†å¹´ä»½</label><select id="mainSolarYear" onchange="refreshSolarDays('mainSolarYear','mainSolarMonth','mainSolarDay',onSolarInputChange)"></select></div>
                        <div class="grid grid-cols-2 gap-3">
                            <div><label class="label-text">åœ‹æ›†æœˆä»½</label><select id="mainSolarMonth" onchange="refreshSolarDays('mainSolarYear','mainSolarMonth','mainSolarDay',onSolarInputChange)"></select></div>
                            <div><label class="label-text">åœ‹æ›†æ—¥æœŸ</label><select id="mainSolarDay" onchange="onSolarInputChange()"></select></div>
                        </div>
                    </div>
                    <div id="lunarInputArea" class="hidden space-y-3">
                        <div><label class="label-text">è¾²æ›†å¹´ä»½</label><select id="inputLunarYear" onchange="refreshLunarDays()"></select></div>
                        <div class="grid grid-cols-2 gap-3">
                            <div><label class="label-text">è¾²æ›†æœˆä»½</label><select id="inputLunarMonth" onchange="refreshLunarDays()"></select></div>
                            <div><label class="label-text">è¾²æ›†æ—¥æœŸ</label><select id="inputLunarDay" onchange="onLunarInputChange()"></select></div>
                        </div>
                    </div>
                    
                    <div class="p-6 bg-slate-800 rounded-2xl text-center shadow-lg relative overflow-hidden text-white mt-4">
                        <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-amber-500 via-white to-amber-500"></div>
                        <div id="resSolarDisplay" class="text-slate-400 font-mono text-xs tracking-wider mb-2"></div>
                        <div id="resLunarDisplay" class="text-3xl font-black text-amber-300 my-2 tracking-widest"></div>
                        <div class="flex justify-center items-center gap-3 mt-4">
                            <span id="resWeekText" class="text-sm font-bold bg-white/10 px-3 py-1 rounded-full"></span>
                            <div id="resZodiacTag" class="text-sm font-bold text-amber-400 border border-amber-400/30 px-3 py-1 rounded-full"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="section-header">
                    <div class="section-title"><span>ğŸ“œ</span> æ­·å²å¹´è™Ÿèˆ‡ç‰Œä½</div>
                </div>
                <div class="space-y-4">
                    <div><label class="label-text">æŸ¥è©¢å¹´ä»½ (è¥¿å…ƒ)</label><input type="number" id="histYear" value="1890" oninput="updateHistory()"></div>
                    <div class="grid grid-cols-2 gap-2">
                        <div><label class="label-text">è¾²æ›†æœˆ</label><select id="histMonth" onchange="updateHistory()"></select></div>
                        <div><label class="label-text">è¾²æ›†æ—¥</label><select id="histDay" onchange="updateHistory()"></select></div>
                    </div>
                    <div class="bg-stone-50 p-4 rounded-xl text-sm space-y-2 border border-stone-200">
                        <div class="flex justify-between"><span>å°æ‡‰å¹´è™Ÿ</span><span id="histEra" class="font-bold text-red-800">--</span></div>
                        <div class="flex justify-between"><span>æ­²æ¬¡å¹²æ”¯</span><span id="histGanzhi" class="font-bold">--</span></div>
                    </div>
                    
                    <div class="ancestor-plate">
                        <div id="histFull" class="text-2xl font-black text-slate-800 tracking-[0.3em] leading-loose">--</div>
                    </div>
                </div>
            </div>
        </div>

        <div id="panel-cer" class="tab-content space-y-4">
            <div class="card border-t-4 border-blue-800">
                <div class="section-header">
                    <div class="section-title"><span>âš–ï¸</span> é‡è¦ç¥­ç¥€æœŸæ—¥è¨ˆç®—</div>
                </div>
                <div class="space-y-4">
                    <div class="space-y-3">
                        <label class="label-text">é€ä¸–æ—¥æœŸ (åœ‹æ›†)</label>
                        <div class="grid grid-cols-3 gap-2">
                            <select id="deathYear" onchange="refreshSolarDays('deathYear','deathMonth','deathDay',updateCeremony)"></select>
                            <select id="deathMonth" onchange="refreshSolarDays('deathYear','deathMonth','deathDay',updateCeremony)"></select>
                            <select id="deathDay" onchange="updateCeremony()"></select>
                        </div>
                    </div>
                    <div class="space-y-3 pt-4">
                        <div class="flex items-center p-4 bg-blue-50 rounded-2xl border border-blue-100">
                            <div class="w-10 h-10 bg-blue-600 rounded-full flex items-center justify-center text-white font-bold mr-3 text-sm">ä¸ƒ</div>
                            <div class="flex-1">
                                <div class="text-xs text-blue-400 font-bold mb-1">é ­ä¸ƒ (ä½œä¸ƒ)</div>
                                <div id="c7" class="font-bold text-blue-900 text-lg">--</div>
                            </div>
                        </div>
                        <div class="flex items-center p-4 bg-slate-50 rounded-2xl border border-slate-200">
                            <div class="w-10 h-10 bg-slate-500 rounded-full flex items-center justify-center text-white font-bold mr-3 text-sm">ç™¾</div>
                            <div class="flex-1">
                                <div class="text-xs text-slate-400 font-bold mb-1">ç™¾æ—¥ (å’å“­)</div>
                                <div id="c100" class="font-bold text-slate-900 text-lg">--</div>
                            </div>
                        </div>
                        <div class="flex items-center p-4 bg-amber-50 rounded-2xl border border-amber-100">
                            <div class="w-10 h-10 bg-amber-600 rounded-full flex items-center justify-center text-white font-bold mr-3 text-sm">å¹´</div>
                            <div class="flex-1">
                                <div class="text-xs text-amber-500 font-bold mb-1">å°å¹´ (å°ç¥¥)</div>
                                <div id="cAnn" class="font-bold text-amber-900 text-lg">--</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="panel-fs" class="tab-content space-y-4">
            <div class="card border-t-4 border-emerald-700">
                <div class="section-header">
                    <div class="section-title"><span>ğŸ§­</span> å¡”ä½æ–¹ä½å»ºè­°</div>
                </div>
                <div class="space-y-4">
                    <div class="space-y-3">
                        <label class="label-text">äº¡è€…å‡ºç”Ÿæ—¥æœŸ (åœ‹æ›†)</label>
                        <div class="grid grid-cols-3 gap-2">
                            <select id="bornYear" onchange="refreshSolarDays('bornYear','bornMonth','bornDay',updateTower)"></select>
                            <select id="bornMonth" onchange="refreshSolarDays('bornYear','bornMonth','bornDay',updateTower)"></select>
                            <select id="bornDay" onchange="updateTower()"></select>
                        </div>
                    </div>
                    
                    <div id="sxDisplay" class="hidden">
                        <div class="flex flex-col items-center mb-6 py-6 bg-gradient-to-br from-emerald-50 to-white rounded-2xl border border-emerald-100 shadow-sm">
                            <div class="text-emerald-400 text-[10px] mb-2 tracking-[0.3em] font-bold uppercase">LIFETIME ELEMENT</div>
                            <div class="flex items-baseline gap-2">
                                <span id="tSX" class="text-5xl font-black text-emerald-900">--</span>
                                <span id="tElTagText" class="text-xl font-bold text-emerald-600">--å‘½</span>
                            </div>
                            <div id="tElTag" class="mt-4 w-12 h-1.5 rounded-full"></div>
                        </div>

                        <div class="divider"><span>å‰å‡¶æ–¹ä½é€ŸæŸ¥</span></div>
                        <div id="dirList" class="space-y-2"></div>
                        
                        <div class="mt-4 px-3 py-2 bg-rose-50 text-xs text-rose-700 rounded-lg border border-rose-100 flex items-center">
                            <span class="mr-2">âš ï¸</span>
                            <span><span id="yearLabel" class="font-bold">--</span>å¹´ç…æ–¹ä½ï¼š<span id="currentYearBad" class="font-black">--</span> (ä¸å®œåšå‘)</span>
                        </div>

                        <div class="mt-4 p-3 bg-stone-100 rounded-xl">
                            <span class="block text-xs font-bold text-stone-500 mb-2 border-b border-stone-200 pb-1">â€» è¾²æ›†æœˆä»½ å¿Œåº§å‘æé†’</span>
                            <div class="grid grid-cols-2 gap-2 text-[11px] text-stone-600">
                                <div>1ã€5ã€9 æœˆ <span class="text-rose-600 font-bold">å¿ŒåŒ—æ–¹</span></div>
                                <div>2ã€6ã€10 æœˆ <span class="text-rose-600 font-bold">å¿Œè¥¿æ–¹</span></div>
                                <div>3ã€7ã€11 æœˆ <span class="text-rose-600 font-bold">å¿Œå—æ–¹</span></div>
                                <div>4ã€8ã€12 æœˆ <span class="text-rose-600 font-bold">å¿Œæ±æ–¹</span></div>
                            </div>
                        </div>
                        
                        <div class="divider"><span>äº”è¡Œèˆ‡ç©ºäº¡è©³è§£</span></div>
                        <div id="elementDetail" class="space-y-3"></div>
                        <div id="voidDetail" class="space-y-3 mt-3"></div>
                    </div>
                    
                    <div id="towerPlaceholder" class="text-center text-stone-400 text-sm py-10 bg-stone-50 rounded-xl border border-dashed border-stone-300">
                        è«‹é¸æ“‡ä¸Šæ–¹æ—¥æœŸä»¥é¡¯ç¤ºé‘‘å®šçµæœ
                    </div>
                </div>
            </div>
        </div>

        <div id="panel-data" class="tab-content space-y-4">
            <div class="card">
                <div class="section-header">
                    <div class="section-title"><span>ğŸº</span> 60 ä»™å‘½é€ŸæŸ¥</div>
                </div>
                <div class="space-y-4">
                    <div>
                        <label class="label-text">ä»™å‘½ (å‡ºç”Ÿå¹´å¹²æ”¯)</label>
                        <select id="xmSelector" onchange="updateXMData()" class="bg-amber-50 border-amber-200 text-amber-900 font-bold"></select>
                    </div>
                    <div id="xmResult" class="space-y-3">
                        <div class="xm-result-box border-l-emerald-500">
                            <span class="xm-tag bg-emerald-100 text-emerald-800">å®œåå±± (å…­å‰)</span>
                            <div id="xmBigLucky" class="text-base font-bold text-emerald-700">--</div>
                        </div>
                        <div class="xm-result-box border-l-rose-500">
                            <span class="xm-tag bg-rose-100 text-rose-800">å¿Œåº§å‘ (å¤§å¿Œ)</span>
                            <div id="xmBigBad" class="text-base font-bold text-rose-700">--</div>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div class="xm-result-box border-l-blue-400">
                                <span class="xm-tag xm-tag-blue">é€€æ–¹ä½</span>
                                <div id="xmRetreat" class="text-sm text-stone-700 font-bold">--</div>
                            </div>
                            <div class="xm-result-box border-l-stone-400">
                                <span class="xm-tag bg-stone-200 text-stone-700">ç…æ–¹ä½</span>
                                <div id="xmKill" class="text-sm text-stone-700 font-bold">--</div>
                            </div>
                        </div>
                        <div class="xm-result-box border-l-amber-400 bg-amber-50/50">
                            <span class="xm-tag xm-tag-amber">å‚™è¨»èˆ‡æˆ¿ä»½å½±éŸ¿</span>
                            <div id="xmSmallBad" class="text-xs text-stone-600 leading-relaxed font-medium">--</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="section-header">
                    <div class="section-title"><span>ğŸŒ™</span> ç ´æœˆèˆ‡å‘½æ ¼</div>
                </div>
                <div class="space-y-4">
                    <div>
                        <label class="label-text">é¸æ“‡ç”Ÿè‚–</label>
                        <select id="pyZodiac" onchange="updatePYData()">
                            <option value="é¼ ">é¼ </option><option value="ç‰›">ç‰›</option><option value="è™">è™</option>
                            <option value="å…”">å…”</option><option value="é¾">é¾</option><option value="è›‡">è›‡</option>
                            <option value="é¦¬">é¦¬</option><option value="ç¾Š">ç¾Š</option><option value="çŒ´">çŒ´</option>
                            <option value="é›">é›</option><option value="ç‹—">ç‹—</option><option value="è±¬">è±¬</option>
                        </select>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="p-4 bg-blue-50 rounded-xl border border-blue-100 text-center">
                            <div class="text-[10px] text-blue-500 font-bold uppercase mb-1">ç”·å‘½ç ´æœˆ</div>
                            <div id="pyMale" class="text-xl font-black text-blue-900">--</div>
                        </div>
                        <div class="p-4 bg-rose-50 rounded-xl border border-rose-100 text-center">
                            <div class="text-[10px] text-rose-500 font-bold uppercase mb-1">å¥³å‘½ç ´æœˆ</div>
                            <div id="pyFemale" class="text-xl font-black text-rose-900">--</div>
                        </div>
                    </div>
                    <div class="p-4 bg-amber-50 rounded-xl border border-amber-100">
                        <div class="text-[10px] text-amber-600 font-bold uppercase mb-1">å‘½æ ¼ç‰¹è³ªåƒè€ƒ</div>
                        <div id="pyDesc" class="text-sm text-amber-900 leading-relaxed font-medium">--</div>
                    </div>
                </div>
            </div>
        </div>

        <div id="panel-ai" class="tab-content">
            <div class="card bg-slate-800 text-white border-none">
                <div class="flex items-center gap-3 mb-6">
                    <div class="w-10 h-10 bg-amber-500 rounded-full flex items-center justify-center text-xl shadow-lg">ğŸ’¡</div>
                    <h2 class="text-xl font-bold text-amber-400">ç¦¾æ¬£ AI ç¦®å„€é¡§å•</h2>
                </div>
                
                <textarea id="aiPrompt" rows="5" class="w-full bg-white/10 border-none text-white placeholder-slate-400 rounded-xl p-4 mb-4 focus:ring-2 ring-amber-500 text-sm" placeholder="æ‚¨å¯ä»¥è©¢å•ï¼šå±¬çŒ´çš„äºº 115 å¹´è¦æ³¨æ„ä»€éº¼ï¼Ÿæˆ–å¦‚ä½•æº–å‚™å°å¹´ç¥­å“ï¼Ÿ"></textarea>
                
                <button onclick="askAI()" id="aiBtn" class="w-full bg-gradient-to-r from-amber-600 to-amber-500 hover:from-amber-500 hover:to-amber-400 py-3 rounded-xl font-bold shadow-lg transition-all active:scale-95 text-white">é€å‡ºè«®è©¢</button>
                
                <div id="aiRes" class="mt-6 p-5 bg-black/20 rounded-xl text-sm leading-relaxed hidden border border-white/10 text-slate-200"></div>
            </div>
        </div>

        <footer class="mt-12 text-center text-slate-400 pb-8">
            <div class="h-px w-20 bg-slate-200 mx-auto mb-4"></div>
            <p class="text-[10px] tracking-[0.3em] uppercase">Hsin Her Funeral Service System</p>
            <p class="text-xs mt-2 font-bold text-slate-500">ç¦¾æ¬£ç”Ÿå‘½ç¦®å„€ Â· å°ˆæ¥­åŠ©æ‰‹ v2.1</p>
        </footer>
    </div>

    <script>
        // --- æ ¸å¿ƒæ•¸æ“šä¿ç•™ ---
        const ZODIAC_ICONS = { "é¼ ": "ğŸ€", "ç‰›": "ğŸ‚", "è™": "ğŸ…", "å…”": "ğŸ‡", "é¾": "ğŸ‰", "è›‡": "ğŸ", "é¦¬": "ğŸ", "ç¾Š": "ğŸ", "çŒ´": "ğŸ’", "é›": "ğŸ“", "ç‹—": "ğŸ•", "è±¬": "ğŸ–" };
        const ZODIAC_DIRECTIONS = {
            "é¼ ": { best: "W", smallLucky: "N", lucky: "E", bad: "S" },
            "ç‰›": { best: "S", smallLucky: "W", lucky: "N", bad: "E" },
            "è™": { best: "E", smallLucky: "S", lucky: "W", bad: "N" },
            "å…”": { best: "N", smallLucky: "E", lucky: "S", bad: "W" },
            "é¾": { best: "W", smallLucky: "N", lucky: "E", bad: "S" },
            "è›‡": { best: "S", smallLucky: "W", lucky: "N", bad: "E" },
            "é¦¬": { best: "E", smallLucky: "S", lucky: "W", bad: "N" },
            "ç¾Š": { best: "N", smallLucky: "E", lucky: "S", bad: "W" },
            "çŒ´": { best: "W", smallLucky: "N", lucky: "E", bad: "S" },
            "é›": { best: "S", smallLucky: "W", lucky: "N", bad: "E" },
            "ç‹—": { best: "E", smallLucky: "S", lucky: "W", bad: "N" },
            "è±¬": { best: "N", smallLucky: "E", lucky: "S", bad: "W" }
        };
        const ELEMENTS = { "è™":"wood", "å…”":"wood", "è›‡":"fire", "é¦¬":"fire", "ç‰›":"earth", "é¾":"earth", "ç¾Š":"earth", "ç‹—":"earth", "çŒ´":"metal", "é›":"metal", "é¼ ":"water", "è±¬":"water" };
        const ELEMENT_DATA = {
            "wood": { name: "æœ¨", color: "é’ã€ç¶ è‰²ç³»", directions: "æ±æ–¹ã€æ±å—æ–¹", desc: "ä»åšæº«å’Œï¼Œè±¡å¾µæ˜¥ç”Ÿèˆ‡æˆé•·ã€‚" },
            "fire": { name: "ç«", color: "ç´…ã€ç´«è‰²ç³»", directions: "å—æ–¹", desc: "ç†±æƒ…ç¦®é‡ï¼Œè±¡å¾µå¤é•·èˆ‡è¼ç…Œã€‚" },
            "earth": { name: "åœŸ", color: "é»ƒã€æ£•è‰²ç³»", directions: "è¥¿å—ã€æ±åŒ—æ–¹", desc: "ç©©é‡èª ä¿¡ï¼Œè±¡å¾µåšå¾·èˆ‡åŒ…å®¹ã€‚" },
            "metal": { name: "é‡‘", color: "ç™½ã€é‡‘è‰²ç³»", directions: "è¥¿æ–¹ã€è¥¿åŒ—æ–¹", desc: "å‰›æ¯…æœæ±ºï¼Œè±¡å¾µç§‹æ”¶èˆ‡éŠ³æ„ã€‚" },
            "water": { name: "æ°´", color: "é»‘ã€è—è‰²ç³»", directions: "åŒ—æ–¹", desc: "éˆå‹•ç¿æ™ºï¼Œè±¡å¾µå†¬è—èˆ‡æ½¤ä¸‹ã€‚" }
        };
        const MAIN_DIRS = [ { id: "W", name: "åè¥¿æœæ± (å…Œ)" }, { id: "N", name: "ååŒ—æœå— (å)" }, { id: "E", name: "åæ±æœè¥¿ (éœ‡)" }, { id: "S", name: "åå—æœåŒ— (é›¢)" } ];

        const XM_DATA = {
            "ç”²å­": { lucky: "å­ã€åˆã€ä¸‘ã€æœªã€å£¬ã€ä¸™", bad: "å¯…ã€ç”²ã€åºšã€ä¹¾ã€å·½ã€å¤", small: "è‘¬å¯…ç”²æ­»é•·å­«ï¼›ç”²åºšéº¼æˆ¿æ•—è²¡ï¼›ä¹¾å·½ä¸­æˆ¿å£èˆŒã€‚å…¥åœ°ç©ºäº¡åœ¨åºšè¾›ã€‚", retreat: "ç”³ã€å­ã€è¾°", kill: "æœª (åŒ—æ–¹)" },
            "ä¹™ä¸‘": { lucky: "å­ã€åˆã€å¯ã€é…‰ã€ä¹™ã€è¾›", bad: "è¾°ã€æˆŒã€ä¸‘ã€æœª", small: "å¿Œè¾°æˆŒä¸‘æœªåå‘ã€‚æ²–æœªå±±ã€‚å‡¡é†œå¹´ä»™å‘½ä¸å®œæ”¹æ›ï¼Œä¸»æäººå£ã€‚", retreat: "å·³ã€é…‰ã€ä¸‘", kill: "ç”³ (è¥¿å—)" },
            "ä¸™å¯…": { lucky: "å­ã€åˆã€å¯…ã€ç”³ã€ä¸™ã€å£¬", bad: "ä¸‘ã€æœªã€ç”²ã€åºšã€å¤ã€ä¹¾", small: "å¿Œä¸‘æœªç”²åºšåå‘ã€‚æ²–ç”³å±±ã€‚ç”³ç‚ºå®˜æ˜Ÿï¼Œæå®˜è·ã€‚", retreat: "å¯…ã€åˆã€æˆŒ", kill: "é…‰ (è¥¿æ–¹)" },
            "ä¸å¯": { lucky: "å¯…ã€ç”³ã€ä¹™ã€è¾›ã€ä¸ã€ç™¸", bad: "å­ã€åˆã€å·³ã€äº¥", small: "å¿Œå­åˆå·³äº¥åå‘ã€‚æ²–é…‰å±±ã€‚ä¸å¯ä»™å‘½è‹¥è‘¬å­åˆï¼Œä¸»äºŒæˆ¿æä¸ã€‚", retreat: "äº¥ã€å¯ã€æœª", kill: "æˆŒ (è¥¿åŒ—)" },
            "æˆŠè¾°": { lucky: "å­ã€åˆã€å¯ã€é…‰ã€æˆŠã€ç™¸", bad: "å¯…ã€ç”³ã€ä¹™ã€è¾›ã€å¤ã€è‰®", small: "å¿Œå¯…ç”³ä¹™è¾›åå‘ã€‚æ²–æˆŒå±±ã€‚æˆŠè¾°å‘½å®œæ“‡æœ¨ç«æ—¥ï¼Œå¿Œé‡‘æ°´æ—¥ã€‚", retreat: "ç”³ã€å­ã€è¾°", kill: "äº¥ (è¥¿åŒ—)" },
            "å·±å·³": { lucky: "å­ã€åˆã€ä¸‘ã€æœªã€å£¬ã€ä¸™", bad: "å¯ã€é…‰ã€ç”²ã€åºšã€ä¹¾ã€å·½", small: "å¿Œå¯é…‰ç”²åºšåå‘ã€‚æ²–äº¥å±±ã€‚å®œé¸åœŸé‡‘æ—¥å‰ã€‚", retreat: "å·³ã€é…‰ã€ä¸‘", kill: "å­ (åŒ—æ–¹)" },
            "åºšåˆ": { lucky: "å­ã€åˆã€å¯…ã€ç”³ã€ä¸™ã€å£¬", bad: "è¾°ã€æˆŒã€ä¹™ã€è¾›ã€å¤ã€è‰®", small: "å¿Œè¾°æˆŒä¹™è¾›åå‘ã€‚æ²–å­å±±ã€‚åˆå¹´ä»™å‘½å¿Œå‹•åœŸã€‚", retreat: "å¯…ã€åˆã€æˆŒ", kill: "ä¸‘ (æ±åŒ—)" },
            "è¾›æœª": { lucky: "å¯…ã€ç”³ã€å¯ã€é…‰ã€ä¸ã€ç™¸", bad: "å·³ã€äº¥", small: "å¿Œå·³äº¥åå‘ã€‚æ²–ä¸‘å±±ã€‚è¾›æœªä»™å‘½å¿Œåœ¨ä¸‘æœˆé€²å¡”ã€‚", retreat: "äº¥ã€å¯ã€æœª", kill: "å¯… (æ±åŒ—)" },
            "å£¬ç”³": { lucky: "å­ã€åˆã€å¯ã€é…‰ã€æˆŠã€ç™¸", bad: "ä¸‘ã€æœªã€ä¹™ã€è¾›ã€è‰®ã€å·½", small: "å¿Œä¸‘æœªä¹™è¾›åå‘ã€‚æ²–å¯…å±±ã€‚å£¬ç”³ä»™å‘½å®œé¸é‡‘æ°´æ—¥ã€‚", retreat: "ç”³ã€å­ã€è¾°", kill: "å¯ (æ±æ–¹)" },
            "ç™¸é…‰": { lucky: "å­ã€åˆã€ä¸‘ã€æœªã€å£¬ã€ä¸™", bad: "å¯…ã€ç”³ã€ç”²ã€åºšã€ä¹¾ã€å¤", small: "å¿Œå¯…ç”³ç”²åºšåå‘ã€‚æ²–å¯å±±ã€‚ç™¸é…‰ä»™å‘½å…¥åœ°ç©ºäº¡åœ¨ä¸ã€‚", retreat: "å·³ã€é…‰ã€ä¸‘", kill: "è¾° (æ±å—)" },
            "ç”²æˆŒ": { lucky: "å­ã€åˆã€å¯ã€é…‰ã€ä¹™ã€è¾›", bad: "ä¸‘ã€æœªã€ç”²ã€åºš", small: "å¿Œä¸‘æœªç”²åºšã€‚æ²–è¾°å±±ã€‚ä¸»é•·æˆ¿ä¸åˆ©ã€‚", retreat: "å¯…ã€åˆã€æˆŒ", kill: "å·³ (æ±å—)" },
            "ä¹™äº¥": { lucky: "å¯…ã€ç”³ã€ä¸™ã€å£¬ã€ç™¸", bad: "å­ã€åˆã€åºšã€å·½", small: "å¿Œå­åˆåºšå·½ã€‚æ²–å·³å±±ã€‚ä¹™äº¥å‘½å®œæœ¨æ°´æ—¥ã€‚", retreat: "äº¥ã€å¯ã€æœª", kill: "åˆ (å—æ–¹)" },
            "ä¸™å­": { lucky: "å¯…ã€ç”³ã€ä¸ã€ç™¸ã€ä¹¾", bad: "ä¸‘ã€æœªã€ä¹™ã€è¾›ã€å¤", small: "å¿Œä¸‘æœªä¹™è¾›ã€‚æ²–åˆå±±ã€‚ä¸™å­å‘½å¿Œåœ¨åˆæœˆä¿®å¢³ã€‚", retreat: "ç”³ã€å­ã€è¾°", kill: "æœª (è¥¿å—)" },
            "ä¸ä¸‘": { lucky: "å¯ã€é…‰ã€ä¸™ã€å£¬ã€å¤", bad: "å¯…ã€ç”³ã€ç”²ã€åºšã€è‰®", small: "å¿Œå¯…ç”³ç”²åºšã€‚æ²–æœªå±±ã€‚ä¸ä¸‘å‘½å®œç«åœŸæ—¥ã€‚", retreat: "å·³ã€é…‰ã€ä¸‘", kill: "ç”³ (è¥¿å—)" },
            "æˆŠå¯…": { lucky: "å­ã€åˆã€ä¹™ã€è¾›ã€è‰®", bad: "å¯ã€é…‰ã€ä¸ã€ç™¸ã€å·½", small: "å¿Œå¯é…‰ä¸ç™¸ã€‚æ²–ç”³å±±ã€‚æˆŠå¯…å‘½å®œåœŸé‡‘æ—¥ã€‚", retreat: "å¯…ã€åˆã€æˆŒ", kill: "é…‰ (è¥¿æ–¹)" },
            "å·±å¯": { lucky: "ä¸‘ã€æœªã€ç”²ã€åºšã€ä¹¾", bad: "è¾°ã€æˆŒã€ä¹™ã€è¾›ã€å·½", small: "å¿Œè¾°æˆŒä¹™è¾›ã€‚æ²–é…‰å±±ã€‚å·±å¯å‘½å¿Œåœ¨é…‰æœˆå®‰è‘¬ã€‚", retreat: "äº¥ã€å¯ã€æœª", kill: "æˆŒ (è¥¿åŒ—)" },
            "åºšè¾°": { lucky: "å¯…ã€ç”³ã€ä¸™ã€å£¬ã€å·½", bad: "å·³ã€äº¥ã€ä¸ã€ç™¸ã€è‰®", small: "å¿Œå·³äº¥ä¸ç™¸ã€‚æ²–æˆŒå±±ã€‚åºšè¾°å‘½å®œé‡‘æ°´æ—¥ã€‚", retreat: "ç”³ã€å­ã€è¾°", kill: "äº¥ (è¥¿åŒ—)" },
            "è¾›å·³": { lucky: "å¯ã€é…‰ã€ä¹™ã€è¾›ã€å¤", bad: "å­ã€åˆã€ç”²ã€åºšã€ä¹¾", small: "å¿Œå­åˆç”²åºšã€‚æ²–äº¥å±±ã€‚è¾›å·³å‘½å¿Œåœ¨äº¥æœˆç¥­ç¥€ã€‚", retreat: "å·³ã€é…‰ã€ä¸‘", kill: "å­ (åŒ—æ–¹)" },
            "å£¬åˆ": { lucky: "è¾°ã€æˆŒã€ä¸ã€ç™¸ã€è‰®", bad: "ä¸‘ã€æœªã€ä¸™ã€å£¬ã€å·½", small: "å¿Œä¸‘æœªä¸™å£¬ã€‚æ²–å­å±±ã€‚å£¬åˆå‘½å®œæ°´æœ¨æ—¥ã€‚", retreat: "å¯…ã€åˆã€æˆŒ", kill: "ä¸‘ (æ±åŒ—)" },
            "ç™¸æœª": { lucky: "å·³ã€äº¥ã€ç”²ã€åºšã€ä¹¾", bad: "å¯…ã€ç”³ã€ä¹™ã€è¾›ã€å¤", small: "å¿Œå¯…ç”³ä¹™è¾›ã€‚æ²–ä¸‘å±±ã€‚ç™¸æœªå‘½å®œæœ¨ç«æ—¥ã€‚", retreat: "äº¥ã€å¯ã€æœª", kill: "å¯… (æ±åŒ—)" },
            "ç”²ç”³": { lucky: "å­ã€åˆã€å¯ã€é…‰ã€ä¹™ã€è¾›", bad: "è¾°ã€æˆŒã€ä¸‘ã€æœª", small: "å¿Œè¾°æˆŒä¸‘æœªã€‚æ²–å¯…å±±ã€‚ç”²ç”³å‘½å®œæ°´æœ¨æ—¥ã€‚", retreat: "ç”³ã€å­ã€è¾°", kill: "å¯ (æ±æ–¹)" },
            "ä¹™é…‰": { lucky: "å¯…ã€ç”³ã€ä¸™ã€å£¬ã€è‰®", bad: "å·³ã€äº¥ã€ä¸ã€ç™¸ã€å·½", small: "å¿Œå·³äº¥ä¸ç™¸ã€‚æ²–å¯å±±ã€‚ä¹™é…‰å‘½å®œé‡‘æ°´æ—¥ã€‚", retreat: "å·³ã€é…‰ã€ä¸‘", kill: "è¾° (æ±å—)" },
            "ä¸™æˆŒ": { lucky: "å¯ã€é…‰ã€ä¸ã€ç™¸ã€å¤", bad: "å­ã€åˆã€ç”²ã€åºšã€ä¹¾", small: "å¿Œå­åˆç”²åºšã€‚æ²–è¾°å±±ã€‚ä¸™æˆŒå‘½å®œç«åœŸæ—¥ã€‚", retreat: "å¯…ã€åˆã€æˆŒ", kill: "å·³ (æ±å—)" },
            "ä¸äº¥": { lucky: "è¾°ã€æˆŒã€ä¹™ã€è¾›ã€å·½", bad: "ä¸‘ã€æœªã€ä¸™ã€å£¬ã€å¤", small: "å¿Œä¸‘æœªä¸™å£¬ã€‚æ²–å·³å±±ã€‚ä¸äº¥å‘½å®œæœ¨ç«æ—¥ã€‚", retreat: "äº¥ã€å¯ã€æœª", kill: "åˆ (å—æ–¹)" },
            "æˆŠå­": { lucky: "å·³ã€äº¥ã€ç”²ã€åºšã€è‰®", bad: "å¯…ã€ç”³ã€ä¹™ã€è¾›ã€å¤", small: "å¿Œå¯…ç”³ä¹™è¾›ã€‚æ²–åˆå±±ã€‚æˆŠå­å‘½å®œåœŸé‡‘æ—¥ã€‚", retreat: "ç”³ã€å­ã€è¾°", kill: "æœª (è¥¿å—)" },
            "å·±ä¸‘": { lucky: "å­ã€åˆã€å¯ã€é…‰ã€ä¹¾", bad: "è¾°ã€æˆŒã€ä¸‘ã€æœªã€å·½", small: "å¿Œè¾°æˆŒä¸‘æœªã€‚æ²–æœªå±±ã€‚å·±ä¸‘å‘½å®œç«åœŸæ—¥ã€‚", retreat: "å·³ã€é…‰ã€ä¸‘", kill: "ç”³ (è¥¿å—)" },
            "åºšå¯…": { lucky: "å¯…ã€ç”³ã€ä¸™ã€å£¬ã€å¤", bad: "å·³ã€äº¥ã€ä¸ã€ç™¸ã€è‰®", small: "å¿Œå·³äº¥ä¸ç™¸ã€‚æ²–ç”³å±±ã€‚åºšå¯…å‘½å®œé‡‘æ°´æ—¥ã€‚", retreat: "å¯…ã€åˆã€æˆŒ", kill: "é…‰ (è¥¿æ–¹)" },
            "è¾›å¯": { lucky: "å¯ã€é…‰ã€ä¹™ã€è¾›ã€å·½", bad: "å­ã€åˆã€ç”²ã€åºšã€ä¹¾", small: "å¿Œå­åˆç”²åºšã€‚æ²–é…‰å±±ã€‚è¾›å¯å‘½å®œåœŸé‡‘æ—¥ã€‚", retreat: "äº¥ã€å¯ã€æœª", kill: "æˆŒ (è¥¿åŒ—)" },
            "å£¬è¾°": { lucky: "è¾°ã€æˆŒã€ä¸ã€ç™¸ã€è‰®", bad: "ä¸‘ã€æœªã€ä¸™ã€å£¬ã€å¤", small: "å¿Œä¸‘æœªä¸™å£¬ã€‚æ²–æˆŒå±±ã€‚å£¬è¾°å‘½å®œæ°´æœ¨æ—¥ã€‚", retreat: "ç”³ã€å­ã€è¾°", kill: "äº¥ (è¥¿åŒ—)" },
            "ç™¸å·³": { lucky: "å·³ã€äº¥ã€ç”²ã€åºšã€ä¹¾", bad: "å¯…ã€ç”³ã€ä¹™ã€è¾›ã€å¤", small: "å¿Œå¯…ç”³ä¹™è¾›ã€‚æ²–äº¥å±±ã€‚ç™¸å·³å‘½å®œæœ¨ç«æ—¥ã€‚", retreat: "å·³ã€é…‰ã€ä¸‘", kill: "å­ (åŒ—æ–¹)" },
            "ç”²åˆ": { lucky: "å­ã€åˆã€å¯ã€é…‰ã€å¤", bad: "è¾°ã€æˆŒã€ä¸‘ã€æœªã€å·½", small: "å¿Œè¾°æˆŒä¸‘æœªã€‚æ²–å­å±±ã€‚ç”²åˆå‘½å®œæ°´æœ¨æ—¥ã€‚", retreat: "å¯…ã€åˆã€æˆŒ", kill: "ä¸‘ (æ±åŒ—)" },
            "ä¹™æœª": { lucky: "å¯…ã€ç”³ã€ä¸™ã€å£¬ã€å·½", bad: "å·³ã€äº¥ã€ä¸ã€ç™¸ã€è‰®", small: "å¿Œå·³äº¥ä¸ç™¸ã€‚æ²–ä¸‘å±±ã€‚ä¹™æœªå‘½å®œæœ¨ç«æ—¥ã€‚", retreat: "äº¥ã€å¯ã€æœª", kill: "å¯… (æ±åŒ—)" },
            "ä¸™ç”³": { lucky: "å¯ã€é…‰ã€ä¹™ã€è¾›", bad: "å­ã€åˆã€ç”²ã€åºš", small: "å¿Œå­åˆç”²åºšã€‚æ²–å¯…å±±ã€‚ä¸™ç”³å‘½å®œç«åœŸæ—¥ã€‚", retreat: "ç”³ã€å­ã€è¾°", kill: "å¯ (æ±æ–¹)" },
            "ä¸é…‰": { lucky: "è¾°ã€æˆŒã€ä¸ã€ç™¸", bad: "ä¸‘ã€æœªã€ä¸™", small: "å¿Œä¸‘æœªä¸™å£¬ã€‚æ²–å¯å±±ã€‚ä¸é…‰å‘½å®œç«åœŸæ—¥ã€‚", retreat: "å·³ã€é…‰ã€ä¸‘", kill: "è¾° (æ±å—)" },
            "æˆŠæˆŒ": { lucky: "å·³ã€äº¥ã€ç”²ã€åºš", bad: "å¯…", small: "å¿Œå¯…ç”³ä¹™è¾›ã€‚æ²–è¾°å±±ã€‚æˆŠæˆŒå‘½å®œåœŸé‡‘æ—¥ã€‚", retreat: "å¯…ã€åˆã€æˆŒ", kill: "å·³ (æ±å—)" },
            "å·±äº¥": { lucky: "å­ã€åˆã€å¯ã€é…‰", bad: "è¾°", small: "å¿Œè¾°æˆŒä¹™è¾›ã€‚æ²–å·³å±±ã€‚å·±äº¥å‘½å®œç«åœŸæ—¥ã€‚", retreat: "äº¥ã€å¯ã€æœª", kill: "åˆ (å—æ–¹)" },
            "åºšå­": { lucky: "å¯…ã€ç”³ã€ä¸™ã€å£¬", bad: "å·³", small: "å¿Œå·³äº¥ä¸ç™¸ã€‚æ²–åˆå±±ã€‚åºšå­å‘½å®œé‡‘æ°´æ—¥ã€‚", retreat: "ç”³ã€å­ã€è¾°", kill: "æœª (è¥¿å—)" },
            "è¾›ä¸‘": { lucky: "å¯ã€é…‰ã€ä¹™ã€è¾›", bad: "å­", small: "å¿Œå­åˆç”²åºšã€‚æ²–æœªå±±ã€‚è¾›ä¸‘å‘½å®œåœŸé‡‘æ—¥ã€‚", retreat: "å·³ã€é…‰ã€ä¸‘", kill: "ç”³ (è¥¿å—)" },
            "å£¬å¯…": { lucky: "è¾°ã€æˆŒã€ä¸ã€ç™¸", bad: "ä¸‘", small: "å¿Œä¸‘æœªä¸™å£¬ã€‚æ²–ç”³å±±ã€‚å£¬å¯…å‘½å®œæ°´æœ¨æ—¥ã€‚", retreat: "å¯…ã€åˆã€æˆŒ", kill: "é…‰ (è¥¿æ–¹)" },
            "ç™¸å¯": { lucky: "å·³ã€äº¥ã€ç”²ã€åºš", bad: "å¯…", small: "å¿Œå¯…ç”³ä¹™è¾›ã€‚æ²–é…‰å±±ã€‚ç™¸å¯å‘½å®œæœ¨ç«æ—¥ã€‚", retreat: "äº¥ã€å¯ã€æœª", kill: "æˆŒ (è¥¿åŒ—)" },
            "ç”²è¾°": { lucky: "å­ã€åˆã€å¯ã€é…‰", bad: "è¾°", small: "å¿Œè¾°æˆŒä¸‘æœªã€‚æ²–æˆŒå±±ã€‚ç”²è¾°å‘½å®œæ°´æœ¨æ—¥ã€‚", retreat: "ç”³ã€å­ã€è¾°", kill: "äº¥ (è¥¿åŒ—)" },
            "ä¹™å·³": { lucky: "å¯…ã€ç”³ã€ä¸™ã€å£¬", bad: "å·³", small: "å¿Œå·³äº¥ä¸ç™¸ã€‚æ²–äº¥å±±ã€‚ä¹™å·³å‘½å®œæœ¨ç«æ—¥ã€‚", retreat: "å·³ã€é…‰ã€ä¸‘", kill: "å­ (åŒ—æ–¹)" },
            "ä¸™åˆ": { lucky: "å¯ã€é…‰ã€ä¸ã€ç™¸", bad: "å­", small: "å¿Œå­åˆç”²åºšã€‚æ²–å­å±±ã€‚ä¸™åˆå‘½å®œç«åœŸæ—¥ã€‚", retreat: "å¯…ã€åˆ-æˆŒ", kill: "ä¸‘ (æ±åŒ—)" },
            "ä¸æœª": { lucky: "è¾°ã€æˆŒã€ä¹™ã€è¾›", bad: "ä¸‘", small: "å¿Œä¸‘æœªä¸™å£¬ã€‚æ²–ä¸‘å±±ã€‚ä¸æœªå‘½å®œç«åœŸæ—¥ã€‚", retreat: "äº¥ã€å¯-æœª", kill: "å¯… (æ±åŒ—)" },
            "æˆŠç”³": { lucky: "å·³ã€äº¥ã€ç”²ã€åºš", bad: "å¯…", small: "å¿Œå¯…ç”³ä¹™è¾›ã€‚æ²–å¯…å±±ã€‚æˆŠç”³å‘½å®œåœŸé‡‘æ—¥ã€‚", retreat: "ç”³ã€å­-è¾°", kill: "å¯ (æ±æ–¹)" },
            "å·±é…‰": { lucky: "å­ã€åˆã€å¯ã€é…‰", bad: "å¯", small: "å¿Œå¯é…‰ç”²åºšã€‚æ²–å¯å±±ã€‚å·±é…‰å‘½å®œç«åœŸæ—¥ã€‚", retreat: "å·³ã€é…‰-ä¸‘", kill: "è¾° (æ±å—)" },
            "åºšæˆŒ": { lucky: "å¯…ã€ç”³", bad: "è¾°", small: "å¿Œè¾°æˆŒä¹™è¾›ã€‚æ²–è¾°å±±ã€‚åºšæˆŒå‘½å®œé‡‘æ°´æ—¥ã€‚", retreat: "å¯…ã€åˆ-æˆŒ", kill: "å·³ (æ±å—)" },
            "è¾›äº¥": { lucky: "å¯ã€é…‰", bad: "å·³", small: "å¿Œå·³äº¥ç”²åºšã€‚æ²–å·³å±±ã€‚è¾›äº¥å‘½å®œåœŸé‡‘æ—¥ã€‚", retreat: "äº¥ã€å¯-æœª", kill: "åˆ (å—æ–¹)" },
            "å£¬å­": { lucky: "è¾°ã€æˆŒ", bad: "åˆ", small: "å¿Œå­åˆä¸™å£¬ã€‚æ²–åˆå±±ã€‚å£¬å­å‘½å®œæ°´æœ¨æ—¥ã€‚", retreat: "ç”³ã€å­-è¾°", kill: "æœª (è¥¿å—)" },
            "ç™¸ä¸‘": { lucky: "å·³ã€äº¥", bad: "æœª", small: "å¿Œä¸‘æœªä¹™è¾›ã€‚æ²–æœªå±±ã€‚ç™¸ä¸‘å‘½å®œæœ¨ç«æ—¥ã€‚", retreat: "å·³ã€é…‰-ä¸‘", kill: "ç”³ (è¥¿å—)" },
            "ç”²å¯…": { lucky: "å­ã€åˆ", bad: "ç”³", small: "å¿Œå¯…ç”³ç”²åºšã€‚æ²–ç”³å±±ã€‚ç”²å¯…å‘½å®œæ°´æœ¨æ—¥ã€‚", retreat: "å¯…ã€åˆ-æˆŒ", kill: "é…‰ (è¥¿æ–¹)" },
            "ä¹™å¯": { lucky: "ä¸‘ã€æœª", bad: "é…‰", small: "å¿Œå¯é…‰ä¹™è¾›ã€‚æ²–é…‰å±±ã€‚ä¹™å¯å‘½å®œæœ¨ç«æ—¥ã€‚", retreat: "äº¥ã€å¯-æœª", kill: "æˆŒ (è¥¿åŒ—)" },
            "ä¸™è¾°": { lucky: "å¯…ã€ç”³", bad: "æˆŒ", small: "å¿Œè¾°æˆŒä¸™å£¬ã€‚æ²–æˆŒå±±ã€‚ä¸™è¾°å‘½å®œç«åœŸæ—¥ã€‚", retreat: "ç”³ã€å­-è¾°", kill: "äº¥ (è¥¿åŒ—)" },
            "ä¸å·³": { lucky: "å¯ã€é…‰", bad: "äº¥", small: "å¿Œå·³äº¥ä¸ç™¸ã€‚æ²–äº¥å±±ã€‚ä¸å·³å‘½å®œç«åœŸæ—¥ã€‚", retreat: "å·³ã€é…‰-ä¸‘", kill: "å­ (åŒ—æ–¹)" },
            "æˆŠåˆ": { lucky: "è¾°ã€æˆŒ", bad: "å­", small: "å¿Œå­åˆæˆŠç™¸ã€‚æ²–å­å±±ã€‚æˆŠåˆå‘½å®œåœŸé‡‘æ—¥ã€‚", retreat: "å¯…ã€åˆ-æˆŒ", kill: "ä¸‘ (æ±åŒ—)" },
            "å·±æœª": { lucky: "å·³ã€äº¥", bad: "ä¸‘", small: "å¿Œä¸‘æœªå·±ç”²ã€‚æ²–ä¸‘å±±ã€‚å·±æœªå‘½å®œç«åœŸæ—¥ã€‚", retreat: "äº¥ã€å¯-æœª", kill: "å¯… (æ±åŒ—)" },
            "åºšç”³": { lucky: "å­ã€åˆ", bad: "å¯…", small: "å¿Œå¯…ç”³åºšä¹™ã€‚æ²–å¯…å±±ã€‚åºšç”³å‘½å®œé‡‘æ°´æ—¥ã€‚", retreat: "ç”³ã€å­-è¾°", kill: "å¯ (æ±æ–¹)" },
            "è¾›é…‰": { lucky: "å¯…ã€ç”³", bad: "å¯", small: "å¿Œå¯é…‰è¾›ä¸™ã€‚æ²–å¯å±±ã€‚è¾›é…‰å‘½å®œåœŸé‡‘æ—¥ã€‚", retreat: "å·³ã€é…‰-ä¸‘", kill: "è¾° (æ±å—)" },
            "å£¬æˆŒ": { lucky: "å¯ã€é…‰", bad: "è¾°", small: "å¿Œè¾°æˆŒå£¬ä¸ã€‚æ²–è¾°å±±ã€‚å£¬æˆŒå‘½å®œæ°´æœ¨æ—¥ã€‚", retreat: "å¯…ã€åˆ-æˆŒ", kill: "å·³ (æ±å—)" },
            "ç™¸äº¥": { lucky: "è¾°ã€æˆŒ", bad: "å·³", small: "å¿Œå·³äº¥ç™¸æˆŠã€‚æ²–å·³å±±ã€‚ç™¸äº¥å‘½å®œæœ¨ç«æ—¥ã€‚", retreat: "äº¥ã€å¯-æœª", kill: "åˆ (å—æ–¹)" }
        };

        const PY_DATA = {
            "é¼ ": { male: "äºŒæœˆ", female: "å…­æœˆ", desc: "ä¸»å€‹æ€§ç›´çˆ½ï¼Œä½†æƒ…ç·’æ³¢å‹•å¤§ï¼Œä¸­å¹´å‰å¾Œéœ€é˜²å®ˆæˆã€‚" },
            "ç‰›": { male: "ä¸‰æœˆ", female: "å››æœˆ", desc: "å‹¤å‹‰å‹å¿ƒä¹‹å‘½ï¼Œå¥³å‘½è¼ƒé¡¯è¾›è‹¦ï¼Œå®œä¿®èº«é½Šå®¶ã€‚" },
            "è™": { male: "åæœˆ", female: "ä¸‰æœˆ", desc: "æ¬ŠåŠ›æ…¾è¼ƒå¼·ï¼Œç”·å‘½å®œåœ¨å¤–ç™¼å±•ï¼Œå¥³å‘½å®œæº«è‰¯ã€‚" },
            "å…”": { male: "äº”æœˆ", female: "æ­£æœˆ", desc: "æŸ”ä¸­å¸¶å‰›ï¼Œç”Ÿæ´»å¤šè®Šå¹»ï¼Œå®œå°‹æ±‚ç©©å®šä¹‹åŸºã€‚" },
            "é¾": { male: "åäºŒæœˆ", female: "å…­æœˆ", desc: "é¾å›°æ·ºç˜ä¹‹è±¡ï¼Œæ—©å¹´å¤šç£¨ç·´ï¼Œæ™šé‹æ–¹äº¨é€šã€‚" },
            "è›‡": { male: "æ­£æœˆ", female: "å››æœˆ", desc: "æ€ç¶­æ•æ·ï¼Œæ˜“é‘½ç‰›è§’å°–ï¼Œå®œå¯¬å¿ƒå¾…äººæ¥ç‰©ã€‚" },
            "é¦¬": { male: "å…«æœˆ", female: "åäºŒæœˆ", desc: "å¥”æ³¢å‹ç¢Œï¼Œäº‹å€åŠŸåŠï¼Œå®œç©©ç´®ç©©æ‰“ä¸å®œå†’éšªã€‚" },
            "ç¾Š": { male: "ä¹æœˆ", female: "åä¸€æœˆ", desc: "å¿ƒæ€§ç´”è‰¯ä½†æ˜“å—æï¼Œéœ€é˜²å°äººè¦¬è¦¦ï¼Œå®œä¿å®ˆã€‚" },
            "çŒ´": { male: "å››æœˆ", female: "åæœˆ", desc: "è°æ˜åè¢«è°æ˜èª¤ï¼Œå®œå°ˆæ³¨æ–¼ä¸€è—ï¼Œé˜²å£èˆŒç³¾ç´›ã€‚" },
            "é›": { male: "åä¸€æœˆ", female: "ä¹æœˆ", desc: "ä¸»è¦‹å¼·çƒˆï¼Œæ˜“èˆ‡å°Šé•·èµ·è¡çªï¼Œå®œå’Œé¡æ‚…è‰²ã€‚" },
            "ç‹—": { male: "å…­æœˆ", female: "ä¸‰æœˆ", desc: "å¿ èª æ­£ç›´ä½†é‹å‹¢èµ·ä¼ï¼Œä¸­æ™šå¹´æœ‰è²´äººç›¸åŠ©ã€‚" },
            "è±¬": { male: "ä¸ƒæœˆ", female: "å…«æœˆ", desc: "ç¦æ°£è¼ƒè–„ï¼Œå®œå¤šè¡Œå–„ç©å¾·ï¼Œç©©å®šä¸­æ±‚ç™¼å±•ã€‚" }
        };

        // --- åŠŸèƒ½å‡½æ•¸ ---

        function switchTab(id) {
            document.querySelectorAll('.tab-content').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('panel-'+id).classList.add('active');
            document.getElementById('tab-'+id).classList.add('active');
        }

        function toTraditional(text) {
            if(!text) return "";
            return text.replace(/é¾™/g, 'é¾').replace(/é©¬/g, 'é¦¬').replace(/é¸¡/g, 'é›').replace(/çŒª/g, 'è±¬').replace(/é—°/g, 'é–');
        }

        window.onload = function() {
            const today = new Date();
            initSelectors();
            initXMSelector();
            
            // åœ‹æ›†åˆå§‹åŒ–
            document.getElementById('mainSolarYear').value = today.getFullYear();
            document.getElementById('mainSolarMonth').value = today.getMonth() + 1;
            refreshSolarDays('mainSolarYear','mainSolarMonth','mainSolarDay', () => { 
                document.getElementById('mainSolarDay').value = today.getDate(); 
                onSolarInputChange(); 
            });
            
            // è¾²æ›†åˆå§‹åŒ–
            document.getElementById('inputLunarYear').value = today.getFullYear();
            refreshLunarDays(() => { 
                document.getElementById('inputLunarMonth').value = 1; 
                refreshLunarDays(() => { 
                    document.getElementById('inputLunarDay').value = 1; 
                    onLunarInputChange(); 
                }); 
            });
            
            // ç¥­ç¥€æ—¥åˆå§‹åŒ–
            document.getElementById('deathYear').value = today.getFullYear();
            document.getElementById('deathMonth').value = today.getMonth() + 1;
            refreshSolarDays('deathYear', 'deathMonth', 'deathDay', () => { 
                document.getElementById('deathDay').value = today.getDate(); 
                updateCeremony(); 
            });
            
            // å¡”ä½åˆå§‹åŒ–
            document.getElementById('bornYear').value = 1971; 
            document.getElementById('bornMonth').value = 1;
            refreshSolarDays('bornYear', 'bornMonth', 'bornDay', () => { 
                document.getElementById('bornDay').value = 1; 
                updateTower(); 
            });
            
            updateHistory();
            updateXMData();
            updatePYData();
        };

        function initSelectors() {
            ['mainSolarYear', 'inputLunarYear', 'deathYear', 'bornYear'].forEach(id => {
                const s = document.getElementById(id);
                for(let y=1920; y<=2050; y++) s.add(new Option((y >= 1912) ? `${y}(${y-1911})å¹´` : `${y}å¹´`, y));
            });
            ['mainSolarMonth', 'deathMonth', 'bornMonth'].forEach(id => {
                const s = document.getElementById(id);
                for(let m=1; m<=12; m++) s.add(new Option(m + "æœˆ", m));
            });
            const mNames = ["","æ­£æœˆ","äºŒæœˆ","ä¸‰æœˆ","å››æœˆ","äº”æœˆ","å…­æœˆ","ä¸ƒæœˆ","å…«æœˆ","ä¹æœˆ","åæœˆ","å†¬æœˆ","è‡˜æœˆ"];
            const dNames = ["","åˆä¸€","åˆäºŒ","åˆä¸‰","åˆå››","åˆäº”","åˆå…­","åˆä¸ƒ","åˆå…«","åˆä¹","åˆå","åä¸€","åäºŒ","åä¸‰","åå››","åäº”","åå…­","åä¸ƒ","åå…«","åä¹","äºŒå","å»¿ä¸€","å»¿äºŒ","å»¿ä¸‰","å»¿å››","å»¿äº”","å»¿å…­","å»¿ä¸ƒ","å»¿å…«","å»¿ä¹","ä¸‰å"];
            const hMonth = document.getElementById('histMonth');
            for(let i=1; i<=12; i++) hMonth.add(new Option(mNames[i], i));
            const hDay = document.getElementById('histDay');
            for(let i=1; i<=30; i++) hDay.add(new Option(dNames[i], i));
        }

        function initXMSelector() {
            const list = ["ç”²å­","ä¹™ä¸‘","ä¸™å¯…","ä¸å¯","æˆŠè¾°","å·±å·³","åºšåˆ","è¾›æœª","å£¬ç”³","ç™¸é…‰","ç”²æˆŒ","ä¹™äº¥","ä¸™å­","ä¸ä¸‘","æˆŠå¯…","å·±å¯","åºšè¾°","è¾›å·³","å£¬åˆ","ç™¸æœª","ç”²ç”³","ä¹™é…‰","ä¸™æˆŒ","ä¸äº¥","æˆŠå­","å·±ä¸‘","åºšå¯…","è¾›å¯","å£¬è¾°","ç™¸å·³","ç”²åˆ","ä¹™æœª","ä¸™ç”³","ä¸é…‰","æˆŠæˆŒ","å·±äº¥","åºšå­","è¾›ä¸‘","å£¬å¯…","ç™¸å¯","ç”²è¾°","ä¹™å·³","ä¸™åˆ","ä¸æœª","æˆŠç”³","å·±é…‰","åºšæˆŒ","è¾›äº¥","å£¬å­","ç™¸ä¸‘","ç”²å¯…","ä¹™å¯","ä¸™è¾°","ä¸å·³","æˆŠåˆ","å·±æœª","åºšç”³","è¾›é…‰","å£¬æˆŒ","ç™¸äº¥"];
            const sel = document.getElementById('xmSelector');
            list.forEach(gz => sel.add(new Option(gz, gz)));
            sel.value = "ç”²å­";
        }

        function updateXMData() {
            const gz = document.getElementById('xmSelector').value;
            const data = XM_DATA[gz] || { 
                lucky: "è«‹åƒé–±é€šæ›¸ (å®œåå±±)",
                bad: "è«‹åƒé–±é€šæ›¸ (å¿Œåå‘)", 
                small: "æš«ç„¡è©³ç´°å‚™è¨»æ•¸æ“š", 
                retreat: "é‘‘å®šä¸­", 
                kill: "å¾…å®š" 
            };
            document.getElementById('xmBigLucky').innerText = data.lucky;
            document.getElementById('xmBigBad').innerText = data.bad;
            document.getElementById('xmSmallBad').innerText = data.small;
            document.getElementById('xmRetreat').innerText = data.retreat;
            document.getElementById('xmKill').innerText = data.kill;
        }

        function updatePYData() {
            const zodiac = document.getElementById('pyZodiac').value;
            const data = PY_DATA[zodiac];
            document.getElementById('pyMale').innerText = data.male;
            document.getElementById('pyFemale').innerText = data.female;
            document.getElementById('pyDesc').innerText = data.desc;
        }

        function setCalendarMode(mode) {
            document.getElementById('solarInputArea').classList.toggle('hidden', mode === 'lunar');
            document.getElementById('lunarInputArea').classList.toggle('hidden', mode === 'solar');
            document.getElementById('btnSolarMode').classList.toggle('active', mode === 'solar');
            document.getElementById('btnLunarMode').classList.toggle('active', mode === 'lunar');
        }

        function refreshSolarDays(yId, mId, dId, callback) {
            const y = parseInt(document.getElementById(yId).value);
            const m = parseInt(document.getElementById(mId).value);
            const dSel = document.getElementById(dId);
            if (!dSel) return;
            const prevD = dSel.value;
            dSel.innerHTML = "";
            const daysInMonth = new Date(y, m, 0).getDate();
            for(let d=1; d<=daysInMonth; d++) dSel.add(new Option(d + "æ—¥", d));
            dSel.value = (prevD && prevD <= daysInMonth) ? prevD : 1;
            if(callback) callback();
        }

        function refreshLunarDays(callback) {
            const year = parseInt(document.getElementById('inputLunarYear').value);
            const monthSel = document.getElementById('inputLunarMonth');
            const daySel = document.getElementById('inputLunarDay');
            const prevMonth = monthSel.value;
            const prevDay = daySel.value;
            monthSel.innerHTML = "";
            const lunarYear = LunarYear.fromYear(year);
            const leapMonth = lunarYear.getLeapMonth();
            const mNames = ["","æ­£æœˆ","äºŒæœˆ","ä¸‰æœˆ","å››æœˆ","äº”æœˆ","å…­æœˆ","ä¸ƒæœˆ","å…«æœˆ","ä¹æœˆ","åæœˆ","å†¬æœˆ","è‡˜æœˆ"];
            for(let m=1; m<=12; m++) {
                monthSel.add(new Option(mNames[m], m));
                if(m === leapMonth) monthSel.add(new Option("é–" + mNames[m], -m));
            }
            monthSel.value = (prevMonth && [...monthSel.options].some(o => o.value == prevMonth)) ? prevMonth : 1;
            const currentMonth = parseInt(monthSel.value);
            daySel.innerHTML = "";
            const monthObj = LunarMonth.fromYm(year, currentMonth);
            const maxDays = monthObj ? monthObj.getDayCount() : 30;
            const tradDNames = ["","åˆä¸€","åˆäºŒ","åˆä¸‰","åˆå››","åˆäº”","åˆå…­","åˆä¸ƒ","åˆå…«","åˆä¹","åˆå","åä¸€","åäºŒ","åä¸‰","åå››","åäº”","åå…­","åä¸ƒ","åå…«","åä¹","äºŒå","å»¿ä¸€","å»¿äºŒ","å»¿ä¸‰","å»¿å››","å»¿äº”","å»¿å…­","å»¿ä¸ƒ","å»¿å…«","å»¿ä¹","ä¸‰å"];
            for(let d=1; d<=maxDays; d++) daySel.add(new Option(tradDNames[d], d));
            daySel.value = (prevDay && prevDay <= maxDays) ? prevDay : 1;
            onLunarInputChange();
            if(callback && typeof callback === 'function') callback();
        }

        function onSolarInputChange() {
            const y = parseInt(document.getElementById('mainSolarYear').value);
            const m = parseInt(document.getElementById('mainSolarMonth').value);
            const d = parseInt(document.getElementById('mainSolarDay').value);
            displayQueryRes(Solar.fromYmd(y, m, d));
        }

        function onLunarInputChange() {
            const y = parseInt(document.getElementById('inputLunarYear').value);
            const m = parseInt(document.getElementById('inputLunarMonth').value);
            const d = parseInt(document.getElementById('inputLunarDay').value);
            try { 
                const lunar = Lunar.fromYmd(y, m, d);
                displayQueryRes(lunar.getSolar()); 
            } catch(e) {}
        }

        function displayQueryRes(solar) {
            const lunar = solar.getLunar();
            const sx = toTraditional(lunar.getYearShengXiao());
            document.getElementById('resSolarDisplay').innerText = `è¥¿å…ƒ ${solar.getYear()} (${solar.getYear()-1911}) å¹´ ${solar.getMonth()} æœˆ ${solar.getDay()} æ—¥`;
            document.getElementById('resLunarDisplay').innerText = `${lunar.getYearInGanZhi()}å¹´ ${toTraditional(lunar.getMonthInChinese())}æœˆ ${lunar.getDayInChinese()}`;
            document.getElementById('resWeekText').innerText = `æ˜ŸæœŸ${solar.getWeekInChinese()}`;
            document.getElementById('resZodiacTag').innerHTML = `<span class="text-lg mr-1">${ZODIAC_ICONS[sx] || ""}</span> å±¬${sx}`;
        }

        function updateCeremony() {
            const y = parseInt(document.getElementById('deathYear').value);
            const m = parseInt(document.getElementById('deathMonth').value);
            const d = parseInt(document.getElementById('deathDay').value);
            const deathDate = new Date(y, m-1, d);
            const fmt = (date) => {
                const s = Solar.fromYmd(date.getFullYear(), date.getMonth()+1, date.getDate());
                return `${s.getYear()>1911?s.getYear()-1911:s.getYear()}å¹´ ${s.getMonth()}/${s.getDay()} (${s.getWeekInChinese()})`;
            };
            const c7 = new Date(deathDate); c7.setDate(deathDate.getDate()+6);
            const c100 = new Date(deathDate); c100.setDate(deathDate.getDate()+99);
            const ann = new Date(deathDate); ann.setFullYear(deathDate.getFullYear()+1);
            document.getElementById('c7').innerText = fmt(c7);
            document.getElementById('c100').innerText = fmt(c100);
            document.getElementById('cAnn').innerText = fmt(ann);
        }

        function updateTower() {
            const y = parseInt(document.getElementById('bornYear').value);
            const m = parseInt(document.getElementById('bornMonth').value);
            const d = parseInt(document.getElementById('bornDay').value);
            const solarObj = Solar.fromYmd(y, m, d);
            const bL = solarObj.getLunar();
            const sx = toTraditional(bL.getYearShengXiao());
            
            document.getElementById('sxDisplay').classList.remove('hidden');
            document.getElementById('towerPlaceholder').classList.add('hidden');
            document.getElementById('tSX').innerText = (ZODIAC_ICONS[sx] || "") + sx;
            
            const elKey = ELEMENTS[sx] || "earth";
            const elInfo = ELEMENT_DATA[elKey];
            document.getElementById('tElTagText').innerText = elInfo.name + "å‘½";
            document.getElementById('tElTag').className = `mt-4 w-12 h-1.5 rounded-full el-${elKey} bg-${elKey === 'wood' ? 'emerald' : (elKey === 'fire' ? 'rose' : (elKey === 'earth' ? 'amber' : (elKey === 'metal' ? 'slate' : 'blue')))}-600`;
            
            const towerData = ZODIAC_DIRECTIONS[sx] || { best: "", smallLucky: "", lucky: "", bad: "" };
            const currentYear = new Date().getFullYear();
            const yearBadDir = ["S", "E", "N", "W"][(currentYear - 2020) % 4];
            const dirMap = { "N": "åŒ—æ–¹", "S": "å—æ–¹", "E": "æ±æ–¹", "W": "è¥¿æ–¹" };
            
            document.getElementById('yearLabel').innerText = currentYear + " (æ°‘åœ‹" + (currentYear-1911) + ") ";
            document.getElementById('currentYearBad').innerText = dirMap[yearBadDir];

            const listEl = document.getElementById('dirList');
            listEl.innerHTML = ""; 
            MAIN_DIRS.forEach(dir => {
                let sClass = "dir-normal", sLabel = "å‰";
                if (dir.id === towerData.best) { sClass = "dir-best"; sLabel = "å¤§å‰"; }
                else if (dir.id === towerData.smallLucky) { sClass = "dir-small-lucky"; sLabel = "å°å‰"; }
                else if (dir.id === towerData.lucky) { sClass = "dir-lucky"; sLabel = "å‰"; }
                else if (dir.id === towerData.bad) { sClass = "dir-bad"; sLabel = "æœ¬å‘½ç…"; }
                let yearTag = dir.id === yearBadDir ? "<span class='text-[9px] bg-rose-600 text-white px-1.5 py-0.5 rounded ml-2'>å¹´ç…</span>" : "";
                const item = document.createElement('div');
                item.className = `dir-item ${sClass}`;
                item.innerHTML = `<span>${dir.name}</span><span class="flex items-center">${yearTag}<span class="ml-2 font-bold">${sLabel}</span></span>`;
                listEl.appendChild(item);
            });

            const detailEl = document.getElementById('elementDetail');
            detailEl.innerHTML = `
                <div class="bg-stone-50 p-3 rounded-xl border border-stone-200">
                    <div class="flex items-center mb-2">
                        <span class="px-3 py-1 rounded-full text-[10px] font-bold bg-stone-200 text-stone-700">${elInfo.name}è¡Œç‰¹è³ª</span>
                    </div>
                    <div class="space-y-1.5 text-xs text-stone-600">
                        <div class="flex justify-between border-b border-stone-100 pb-1"><span>ä»£è¡¨è‰²ç³»</span><span class="font-bold">${elInfo.color}</span></div>
                        <div class="flex justify-between"><span>å»ºè­°æ–¹ä½</span><span class="font-bold">${elInfo.directions}</span></div>
                    </div>
                    <div class="mt-2 text-[10px] text-stone-500 italic">"${elInfo.desc}"</div>
                </div>
            `;

            const dayGanZhi = bL.getDayInGanZhi();
            const voidList = getDayVoid(dayGanZhi);
            const voidDetailEl = document.getElementById('voidDetail');
            voidDetailEl.innerHTML = `
                <div class="bg-rose-50 p-3 rounded-xl border border-rose-100">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-[10px] font-bold bg-rose-600 text-white px-2 py-0.5 rounded">æ—¥æŸ±ç©ºäº¡</span>
                        <span class="text-[11px] font-bold text-rose-900">${dayGanZhi}æ—¥å‡ºç”Ÿ</span>
                    </div>
                    <div class="text-[11px] text-rose-800 leading-relaxed">
                        æœ¬å‘½ç©ºäº¡æ–¹ä½ï¼š<span class="font-bold mx-1 text-lg">${voidList.join('ã€')}</span>
                        <p class="mt-1 opacity-70 text-[10px]">â€» æ“‡ä½æ™‚å¯é¿é–‹ä¸Šè¿°åœ°æ”¯å°æ‡‰ä¹‹æ–¹ä½ï¼Œä»¥æ±‚åœ“æ»¿ã€‚</p>
                    </div>
                </div>
            `;
        }

        function getDayVoid(gz) {
            const list = ["ç”²å­","ä¹™ä¸‘","ä¸™å¯…","ä¸å¯","æˆŠè¾°","å·±å·³","åºšåˆ","è¾›æœª","å£¬ç”³","ç™¸é…‰","ç”²æˆŒ","ä¹™äº¥","ä¸™å­","ä¸ä¸‘","æˆŠå¯…","å·±å¯","åºšè¾°","è¾›å·³","å£¬åˆ","ç™¸æœª","ç”²ç”³","ä¹™é…‰","ä¸™æˆŒ","ä¸äº¥","æˆŠå­","å·±ä¸‘","åºšå¯…","è¾›å¯","å£¬è¾°","ç™¸å·³","ç”²åˆ","ä¹™æœª","ä¸™ç”³","ä¸é…‰","æˆŠæˆŒ","å·±äº¥","åºšå­","è¾›ä¸‘","å£¬å¯…","ç™¸å¯","ç”²è¾°","ä¹™å·³","ä¸™åˆ","ä¸æœª","æˆŠç”³","å·±é…‰","åºšæˆŒ","è¾›äº¥","å£¬å­","ç™¸ä¸‘","ç”²å¯…","ä¹™å¯","ä¸™è¾°","ä¸å·³","æˆŠåˆ","å·±æœª","åºšç”³","è¾›é…‰","å£¬æˆŒ","ç™¸äº¥"];
            const idx = list.indexOf(gz);
            if(idx === -1) return ["æœªçŸ¥"];
            if(idx < 10) return ["æˆŒ(è¥¿åŒ—)","äº¥(è¥¿åŒ—)"];
            if(idx < 20) return ["ç”³(è¥¿å—)","é…‰(æ­£è¥¿)"];
            if(idx < 30) return ["åˆ(æ­£å—)","æœª(è¥¿å—)"];
            if(idx < 40) return ["è¾°(æ±å—)","å·³(æ±å—)"];
            if(idx < 50) return ["å¯…(æ±åŒ—)","å¯(æ­£æ±)"];
            return ["å­(æ­£åŒ—)","ä¸‘(æ±åŒ—)"];
        }

        function updateHistory() {
            const y = parseInt(document.getElementById('histYear').value || 1890);
            const eraTxt = (y > 1911) ? `ä¸­è¯æ°‘åœ‹ ${y-1911} å¹´` : (y >= 1875 ? `æ¸… å…‰ç·’ ${y-1874} å¹´` : (y >= 1862 ? `æ¸… åŒæ²» ${y-1861} å¹´` : `è¥¿å…ƒ ${y} å¹´`));
            document.getElementById('histEra').innerText = eraTxt;
            document.getElementById('histGanzhi').innerText = Lunar.fromYmd(y, 1, 1).getYearInGanZhi() + "å¹´";
            const m = document.getElementById('histMonth').options[document.getElementById('histMonth').selectedIndex]?.text || "æ­£æœˆ";
            const d = document.getElementById('histDay').options[document.getElementById('histDay').selectedIndex]?.text || "åˆä¸€";
            document.getElementById('histFull').innerText = `${eraTxt} ${m} ${d}`;
        }

        // AI é‚è¼¯ (å®Œå…¨ä¿ç•™)
        async function askAI() {
            const prompt = document.getElementById('aiPrompt').value;
            const resBox = document.getElementById('aiRes');
            const btn = document.getElementById('aiBtn');
            if(!prompt.trim()) return;

            btn.disabled = true;
            btn.innerText = "é¡§å•æ€è€ƒä¸­...";
            resBox.classList.remove('hidden');
            resBox.innerText = "æ­£åœ¨è«®è©¢ç¦¾æ¬£ç¦®å„€å°ˆå®¶ï¼Œè«‹ç¨å€™...";

            const apiKey = ""; // è«‹å¡«å…¥æ‚¨çš„ API Key
            const systemPrompt = "ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„ç”Ÿå‘½ç¦®å„€é¡§å•ï¼Œæ“…é•·é™°é™½æ›†æ³•ã€ç”Ÿè‚–æ–¹ä½é‘‘å®šèˆ‡æ²»å–ªæµç¨‹è¦åŠƒã€‚è«‹ä»¥å°ˆæ¥­ã€æº«å’Œä¸”æ˜“æ‡‚çš„ç¹é«”ä¸­æ–‡å›ç­”å•é¡Œã€‚";
            
            const fetchWithRetry = async (url, options, retries = 5, backoff = 1000) => {
                try {
                    const response = await fetch(url, options);
                    if (!response.ok) throw new Error('API request failed');
                    return await response.json();
                } catch (error) {
                    if (retries <= 0) throw error;
                    await new Promise(resolve => setTimeout(resolve, backoff));
                    return fetchWithRetry(url, options, retries - 1, backoff * 2);
                }
            };

            try {
                const result = await fetchWithRetry(
                    `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`,
                    {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: prompt }] }],
                            systemInstruction: { parts: [{ text: systemPrompt }] }
                        })
                    }
                );
                const reply = result.candidates?.[0]?.content?.parts?.[0]?.text;
                resBox.innerText = reply || "ç›®å‰è«®è©¢é‡è¼ƒå¤§ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚";
            } catch (error) {
                resBox.innerText = "æŠ±æ­‰ï¼Œç›®å‰ç„¡æ³•é€£æ¥åˆ°å°ˆå®¶ç³»çµ±ã€‚è«‹æª¢æŸ¥ç¶²è·¯æˆ–ç¨å¾Œå†è©¦ã€‚";
            } finally {
                btn.disabled = false;
                btn.innerText = "é€å‡ºè«®è©¢";
            }
        }
    </script>
</body>
</html>